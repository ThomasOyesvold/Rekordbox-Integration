---
phase: 04-verification-workflow-and-playback
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - renderer/components/WaveformPlayer.jsx
  - renderer/App.jsx
autonomous: true

must_haves:
  truths:
    - User can see full interactive waveform for selected track
    - Clicking waveform seeks audio to that position
    - Waveform renders with proper colors from ANLZ data
    - Playback progress indicator moves across waveform
  artifacts:
    - renderer/components/WaveformPlayer.jsx
    - package.json (with wavesurfer.js dependencies)
  key_links:
    - WaveformPlayer integrated into PlaylistView
    - Uses existing normalizeAudioLocation and bridge verification
    - Connects to existing playback state management
---

<objective>
Add full interactive waveform visualization using WaveSurfer.js for tracks in suggested playlists.

Purpose: Visual verification allows users to see track structure and energy patterns before listening.
Output: WaveformPlayer component with seek interaction and ANLZ color data integration.
</objective>

<execution_context>
@/home/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/home/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-verification-workflow-and-playback/04-RESEARCH.md

# Audio infrastructure
@renderer/App.jsx
@electron/preload.cjs
@electron/main.js
@AUDIO_FIX_IMPLEMENTATION.md

# ANLZ waveform data
@src/services/anlzWaveformService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install WaveSurfer.js dependencies</name>
  <files>package.json</files>
  <action>
Install WaveSurfer.js React wrapper:
```bash
npm install wavesurfer.js @wavesurfer/react
```

Verify installation completes successfully.
  </action>
  <verify>
```bash
# Dependencies in package.json
grep -E "(wavesurfer.js|@wavesurfer/react)" package.json

# Installed in node_modules
ls node_modules/wavesurfer.js node_modules/@wavesurfer/react
```
  </verify>
  <done>
wavesurfer.js and @wavesurfer/react installed and listed in package.json dependencies
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WaveformPlayer component</name>
  <files>renderer/components/WaveformPlayer.jsx</files>
  <action>
Create React component using @wavesurfer/react that:
- Uses useWavesurfer hook for waveform rendering
- Receives track object with fileUrl (normalized audio location)
- Configures waveform with ANLZ RGB color data if available
- Defaults to blue waveform if no ANLZ colors
- Handles click-to-seek on waveform
- Shows play/pause button
- Displays current time / duration
- Connects to existing playback state management (playbackStates from App.jsx)
- Uses memoized plugins array (critical - see research pitfall #1)
- Height: 128px, normalize: true, barWidth: 2, barGap: 1

CRITICAL: Follow research guidance:
- Memoize plugins array with useMemo()
- Use existing audio verification before creating waveform (resolveAudioPath)
- Handle MediaError codes 3 and 4 for format support
  </action>
  <verify>
```bash
# Component file exists
ls renderer/components/WaveformPlayer.jsx

# Contains WaveSurfer imports and key patterns
grep "useWavesurfer" renderer/components/WaveformPlayer.jsx
grep "useMemo" renderer/components/WaveformPlayer.jsx
grep "waveColor" renderer/components/WaveformPlayer.jsx

# Verify MediaError handling connected (WORK-04)
grep -E "(MediaError|MEDIA_ERR_)" renderer/components/WaveformPlayer.jsx
```
  </verify>
  <done>
WaveformPlayer.jsx created with interactive waveform, seek functionality, ANLZ color support
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate WaveformPlayer into track display</name>
  <files>renderer/App.jsx, renderer/components/PlaylistView.jsx</files>
  <action>
Add WaveformPlayer to track details:
- Import WaveformPlayer component
- Show waveform when track is selected in playlist view
- Pass normalized audio URL via normalizeAudioLocation()
- Pass ANLZ waveform color data (track.anlzWaveform.binColors, track.anlzWaveform.avgColor)
- Connect to existing playback state (getPlaybackState, updatePlaybackState)
- Show waveform in expanded track view or detail panel
- Ensure only one waveform renders at a time (performance)

Use existing audio infrastructure:
- normalizeAudioLocation(track.location, { debug: true })
- bridgeApi.resolveAudioPath(fileUrl) for verification
- Existing playback state management patterns
  </action>
  <verify>
```bash
# WaveformPlayer imported and used
grep "import.*WaveformPlayer" renderer/App.jsx
grep "<WaveformPlayer" renderer/App.jsx

# Passes track data and playback state
grep -A 3 "WaveformPlayer" renderer/App.jsx | grep -E "(track|playback|waveform)"
```
  </verify>
  <done>
WaveformPlayer integrated, shows interactive waveform for selected tracks, connects to existing playback
  </done>
</task>

</tasks>

<success_criteria>
**Acceptance:**
1. User can see full interactive waveform when viewing track details
2. Clicking on waveform seeks audio to that position
3. Waveform uses ANLZ RGB colors if available, falls back to blue
4. Playback progress indicator moves across waveform in real-time
5. Play/pause controls work from waveform component
6. Waveform respects existing file verification (shows error if file not found)

**Testing:**
```bash
# Visual verification in Electron app
npm run start:electron:safe
# 1. Load XML with ANLZ waveform data
# 2. Navigate to suggested playlist
# 3. Select a track to view details
# 4. Verify full waveform renders with colors
# 5. Click waveform to seek - audio should jump to that position
# 6. Click play - verify progress indicator moves across waveform
# 7. Test with track without ANLZ data - should show blue waveform
```

**Edge cases:**
- File not found: Should show error message, no waveform
- Format not supported: Should show MediaError message
- No ANLZ data: Should render waveform in default blue color
- Rapid track switching: Should clean up previous waveform properly
</success_criteria>

<must_have_derivation>
**Goal:** User can see waveform visualizations for tracks in suggested playlist (WORK-02)

**Critical behaviors:**
- Full interactive waveform must render for any track
- Clicking waveform must seek audio playback
- RGB energy patterns from ANLZ data must be visible
- Waveform must update during playback to show progress

**Critical artifacts:**
- WaveformPlayer.jsx component (interactive waveform UI)
- wavesurfer.js dependencies in package.json

**Critical connections:**
- WaveformPlayer uses existing audio verification (resolveAudioPath)
- WaveformPlayer connects to existing playback state management
- ANLZ waveform RGB data flows from anlzWaveformService to WaveformPlayer
- WaveSurfer.js plugins must be memoized to avoid re-initialization
</must_have_derivation>
