---
phase: 04-verification-workflow-and-playback
plan: 03
type: execute
wave: 2
depends_on: [01, 02]
files_modified:
  - renderer/components/RandomSampler.jsx
  - renderer/App.jsx
  - renderer/components/PlaylistView.jsx
autonomous: true

must_haves:
  truths:
    - User can trigger random sampling for any suggested playlist
    - Sampling selects 10-20 random tracks (configurable)
    - Selected tracks play sequentially with auto-advance
    - User can skip to next track in sample
    - User can stop sampling and return to playlist view
  artifacts:
    - renderer/components/RandomSampler.jsx
  key_links:
    - RandomSampler integrated into PlaylistView
    - Uses Fisher-Yates shuffle for unbiased sampling
    - Uses existing playback infrastructure (playTrack, stopPlayback)
---

<objective>
Implement random sampling workflow allowing users to verify playlist vibe by playing 10-20 random tracks without listening to entire playlist.

Purpose: Listening to 200+ tracks is impractical; random sampling gives accurate vibe check efficiently.
Output: RandomSampler component with configurable sample size, auto-play queue, skip controls.
</objective>

<execution_context>
@/home/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/home/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-verification-workflow-and-playback/04-RESEARCH.md

# Playback infrastructure
@renderer/App.jsx
@AUDIO_FIX_IMPLEMENTATION.md

# Playlist view from Plan 01
@.planning/phases/04-verification-workflow-and-playback/04-01-PLAN.md
@renderer/components/PlaylistView.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RandomSampler component with Fisher-Yates shuffle</name>
  <files>renderer/components/RandomSampler.jsx</files>
  <action>
Create React component that:
- Receives playlist object with tracks array
- Shows sample size input (10-20 tracks, default 15)
- Shows "Generate Random Sample" button
- Implements Fisher-Yates shuffle for unbiased selection:
```javascript
function selectRandomTracks(tracks, count) {
  const shuffled = [...tracks]; // Copy to avoid mutation
  let currentIndex = shuffled.length;
  while (currentIndex > 0) {
    const randomIndex = Math.floor(Math.random() * currentIndex);
    currentIndex--;
    [shuffled[currentIndex], shuffled[randomIndex]] =
      [shuffled[randomIndex], shuffled[currentIndex]];
  }
  return shuffled.slice(0, Math.min(count, shuffled.length));
}
```
- Displays sampled tracks list with numbering (1/15, 2/15, etc.)
- Shows currently playing track highlighted
- Includes controls: Play/Pause, Next, Stop Sampling
- Auto-advances to next track when current track ends
- Returns to playlist view when sampling complete or stopped
  </action>
  <verify>
```bash
# Component file exists
ls renderer/components/RandomSampler.jsx

# Contains key elements
grep -E "(Fisher-Yates|selectRandomTracks|shuffled)" renderer/components/RandomSampler.jsx
grep -E "(sample size|Generate.*Sample|Next|Stop)" renderer/components/RandomSampler.jsx
```
  </verify>
  <done>
RandomSampler.jsx created with Fisher-Yates shuffle, configurable sample size, playback controls
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate RandomSampler with existing playback</name>
  <files>renderer/App.jsx</files>
  <action>
Connect RandomSampler to App.jsx playback infrastructure:
- Use existing playTrack(track, seekSeconds) for playback
- Use existing stopPlayback(trackId) for cleanup
- Use existing updatePlaybackState and getPlaybackState
- Listen to audio 'ended' event to auto-advance to next track
- Handle rapid track switching with existing play request guards
- Show sampling mode state (active/inactive)
- Display current track number in sample (e.g., "Playing 3 of 15")

Auto-advance logic:
```javascript
audio.addEventListener('ended', () => {
  const currentIndex = sampledTracks.findIndex(t => t.id === track.id);
  const nextTrack = sampledTracks[currentIndex + 1];
  if (nextTrack) {
    playTrack(nextTrack); // Auto-play next
  } else {
    // Sampling complete
    setSamplingActive(false);
  }
});
```
  </action>
  <verify>
```bash
# RandomSampler imported and playback integrated
grep "import.*RandomSampler" renderer/App.jsx
grep -E "(playTrack|stopPlayback)" renderer/App.jsx

# Auto-advance logic exists
grep -A 5 "ended" renderer/App.jsx | grep -E "(nextTrack|auto)"

# Verify format support handling (WORK-04)
grep -E "(MediaError|format|audio.*error)" renderer/App.jsx | head -5
```
  </verify>
  <done>
RandomSampler connected to playback, auto-advances through sample, uses existing audio infrastructure
  </done>
</task>

<task type="auto">
  <name>Task 3: Add sampling UI to PlaylistView</name>
  <files>renderer/components/PlaylistView.jsx</files>
  <action>
Enhance PlaylistView with sampling features:
- Add "Verify with Random Sample" button for each playlist
- Show sample size selector (10-20 tracks)
- Toggle between playlist view and sampling view
- Display sampling progress (track 3 of 15)
- Show "Stop Sampling" button to return to playlist
- Highlight currently playing track in sampled list
- Show track metadata in sampling view (artist, title, BPM, key)
- Include mini waveform for each sampled track

UI layout:
```
[Playlist Name]
Confidence: 85% | Tracks: 47 | BPM: 125-130

[Verify with Random Sample (15 tracks)]

--- When sampling active ---
Sampling 15 tracks:
→ 1. Track A - Artist A (125 BPM) ◀ Playing
  2. Track B - Artist B (127 BPM)
  3. Track C - Artist C (128 BPM)
  ...

[Stop Sampling] [Next Track]
```
  </action>
  <verify>
```bash
# Sampling UI elements exist
grep -E "(Random Sample|sample size|Sampling.*tracks)" renderer/components/PlaylistView.jsx
grep -E "(Stop Sampling|Next Track)" renderer/components/PlaylistView.jsx

# RandomSampler component imported
grep "import.*RandomSampler" renderer/components/PlaylistView.jsx
```
  </verify>
  <done>
PlaylistView shows sampling controls, toggles between playlist and sampling view, displays progress
  </done>
</task>

</tasks>

<success_criteria>
**Acceptance:**
1. User can click "Verify with Random Sample" on any suggested playlist
2. Sample size is configurable (10-20 tracks, default 15)
3. Fisher-Yates shuffle selects tracks without bias
4. Tracks play sequentially with auto-advance on 'ended' event
5. User can skip to next track or stop sampling
6. Sampling view shows progress (track X of N)
7. Currently playing track is highlighted
8. Returns to playlist view when sampling completes or stopped

**Testing:**
```bash
# Functional verification in Electron app
npm run start:electron:safe
# 1. Load XML and generate suggested playlists
# 2. Click "Verify with Random Sample" on a playlist
# 3. Verify 15 random tracks selected (default)
# 4. Click Play - first track should play
# 5. Wait for track to end - should auto-advance to track 2
# 6. Click Next - should skip to track 3
# 7. Click Stop Sampling - should return to playlist view
# 8. Try different sample sizes (10, 15, 20)
# 9. Try sampling from playlist with <10 tracks - should sample all
```

**Edge cases:**
- Playlist has fewer tracks than sample size: Sample all available tracks
- File not found during sampling: Skip to next track with error message
- Rapid clicking Next: Should use existing play request guards
- Stop sampling while track playing: Should stop audio properly
</success_criteria>

<must_have_derivation>
**Goal:** User can play random sampling (10-20 random tracks) from any suggested playlist to verify vibe (WORK-03)

**Critical behaviors:**
- Random selection must be unbiased (Fisher-Yates shuffle)
- Tracks must play sequentially without manual intervention
- User must be able to skip or stop sampling
- Sample size must be configurable (10-20 tracks)
- Progress must be visible (track X of N)

**Critical artifacts:**
- RandomSampler.jsx component (sampling logic and UI)

**Critical connections:**
- RandomSampler uses existing playTrack() and stopPlayback() from App.jsx
- Fisher-Yates shuffle ensures unbiased track selection
- Audio 'ended' event drives auto-advance to next track
- Play request guards prevent race conditions during rapid skipping
- Sampling view integrates seamlessly into PlaylistView component
</must_have_derivation>
