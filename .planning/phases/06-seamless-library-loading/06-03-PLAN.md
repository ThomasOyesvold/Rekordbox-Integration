---
phase: 06-seamless-library-loading
plan: 03
type: execute
wave: 2
depends_on: [01, 02]
files_modified:
  - renderer/components/SetupWizard.jsx
  - renderer/components/AppHeader.jsx
  - renderer/App.jsx
  - renderer/styles/components.css
autonomous: true

must_haves:
  truths:
    - SetupWizard shows ANLZ folder section with auto-detect badge when path found
    - App header shows "Refresh Library" button once library is loaded
    - Stale library shows yellow warning indicator in header
    - Parse progress shows three distinct stages (XML, waveform index, attaching)
  artifacts:
    - renderer/components/SetupWizard.jsx (ANLZ section)
    - renderer/components/AppHeader.jsx (refresh button + stale indicator)
    - renderer/styles/components.css (new styles)
  key_links:
    - SetupWizard receives usbAnlzPath, anlzDetected, onPickAnlzFolder props from App.jsx
    - AppHeader receives hasLibrary, isStale, onRefresh props from App.jsx
    - refreshLibrary() function in App.jsx (from Plan 01) wired to AppHeader
---

<objective>
Polish the setup flow and app header with clear ANLZ configuration and library refresh controls.

Purpose: Plans 01 and 02 add the underlying functionality. This plan adds the visible UX that makes it discoverable and satisfying to use.
Output: ANLZ folder shown in SetupWizard setup, "Refresh Library" in header, three-stage parse progress.
</objective>

<execution_context>
@/home/thomas/.claude/get-shit-done/workflows/execute-plan.md
@/home/thomas/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-seamless-library-loading/06-01-PLAN.md
@.planning/phases/06-seamless-library-loading/06-02-PLAN.md

# Components to update
@renderer/components/SetupWizard.jsx
@renderer/components/AppHeader.jsx
@renderer/App.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ANLZ folder section to SetupWizard</name>
  <files>renderer/components/SetupWizard.jsx</files>
  <action>
Add new props to SetupWizard: `usbAnlzPath`, `anlzDetected`, `onPickAnlzFolder`

Below the drop zone (before the recent imports section), add an ANLZ configuration section:

```jsx
import { Upload, FolderOpen, Activity, Loader2 } from 'lucide-react';

// Add inside SetupWizard component, after drop zone:
<div className="anlz-section">
  <div className="anlz-section-header">
    <Activity size={14} />
    <span>Waveform Data</span>
    {anlzDetected && usbAnlzPath && (
      <span className="anlz-badge-detected">Auto-detected</span>
    )}
  </div>
  <p className="anlz-hint">
    Point to your Rekordbox USBANLZ folder to load waveform colors automatically.
  </p>
  <div className="anlz-path-row">
    <div className="anlz-path-display">
      {usbAnlzPath
        ? <span className="anlz-path-value">{usbAnlzPath}</span>
        : <span className="anlz-path-empty">No folder selected — waveforms will be skipped</span>
      }
    </div>
    <Button variant="secondary" size="sm" onClick={onPickAnlzFolder}>
      Browse
    </Button>
  </div>
  {usbAnlzPath && (
    <p className="anlz-ready-hint">
      Waveforms will build automatically when you parse.
    </p>
  )}
</div>
```

**Add CSS to renderer/styles/components.css:**
```css
.anlz-section {
  margin-top: var(--space-6);
  padding-top: var(--space-6);
  border-top: 1px solid var(--border-subtle);
}

.anlz-section-header {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  font-size: var(--text-sm);
  font-weight: var(--weight-semibold);
  color: var(--text-secondary);
  margin-bottom: var(--space-2);
}

.anlz-badge-detected {
  padding: 2px var(--space-2);
  font-size: var(--text-xs);
  font-weight: var(--weight-semibold);
  background: rgba(16, 185, 129, 0.15);
  color: var(--accent-success);
  border: 1px solid var(--accent-success);
  border-radius: var(--radius-full);
}

.anlz-hint {
  font-size: var(--text-sm);
  color: var(--text-tertiary);
  margin-bottom: var(--space-3);
}

.anlz-path-row {
  display: flex;
  gap: var(--space-2);
  align-items: center;
}

.anlz-path-display {
  flex: 1;
  padding: var(--space-2) var(--space-3);
  background: var(--bg-tertiary);
  border: 1px solid var(--border-medium);
  border-radius: var(--radius-sm);
  font-size: var(--text-sm);
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.anlz-path-value {
  color: var(--text-primary);
  font-family: var(--font-mono);
  font-size: var(--text-xs);
}

.anlz-path-empty {
  color: var(--text-tertiary);
  font-style: italic;
}

.anlz-ready-hint {
  margin-top: var(--space-2);
  font-size: var(--text-xs);
  color: var(--accent-success);
}
```
  </action>
  <verify>
```bash
# New props accepted
grep -E "(usbAnlzPath|anlzDetected|onPickAnlzFolder)" renderer/components/SetupWizard.jsx

# Section present
grep "anlz-section" renderer/components/SetupWizard.jsx

# Activity icon imported
grep "Activity" renderer/components/SetupWizard.jsx

# CSS exists
grep "anlz-section" renderer/styles/components.css
```
  </verify>
  <done>
SetupWizard shows ANLZ folder section with auto-detect badge and Browse button
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Refresh Library button and stale indicator to AppHeader</name>
  <files>renderer/components/AppHeader.jsx</files>
  <action>
Add new props to AppHeader: `hasLibrary`, `isStale`, `isRefreshing`, `onRefresh`

Update the header right section to include a conditional refresh area:

```jsx
import { Settings, RefreshCw, AlertTriangle } from 'lucide-react';

// In AppHeader, update header-right:
<div className="header-right">
  {hasLibrary && (
    <div className="header-library-status">
      {isStale && (
        <div className="stale-indicator">
          <AlertTriangle size={14} />
          <span>Library may be outdated</span>
        </div>
      )}
      <button
        className={`refresh-btn ${isRefreshing ? 'refreshing' : ''}`}
        onClick={onRefresh}
        disabled={isRefreshing}
        title="Re-parse library for new tracks"
      >
        <RefreshCw size={16} className={isRefreshing ? 'spin' : ''} />
        <span>Refresh Library</span>
      </button>
    </div>
  )}
  <IconButton
    icon={<Settings size={20} />}
    onClick={onSettingsClick}
    aria-label="Settings"
  />
</div>
```

**Add CSS to renderer/styles/components.css:**
```css
.header-library-status {
  display: flex;
  align-items: center;
  gap: var(--space-3);
}

.stale-indicator {
  display: flex;
  align-items: center;
  gap: var(--space-1);
  padding: var(--space-1) var(--space-3);
  font-size: var(--text-xs);
  font-weight: var(--weight-medium);
  color: var(--accent-warning);
  background: rgba(245, 158, 11, 0.1);
  border: 1px solid rgba(245, 158, 11, 0.3);
  border-radius: var(--radius-full);
}

.refresh-btn {
  display: flex;
  align-items: center;
  gap: var(--space-2);
  padding: var(--space-2) var(--space-4);
  font-size: var(--text-sm);
  font-weight: var(--weight-medium);
  color: var(--text-primary);
  background: transparent;
  border: 1px solid var(--border-medium);
  border-radius: var(--radius-sm);
  cursor: pointer;
  transition: all var(--transition-base);
}

.refresh-btn:hover:not(:disabled) {
  background: var(--bg-tertiary);
  border-color: var(--accent-primary);
  color: var(--accent-primary);
}

.refresh-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.refresh-btn .spin {
  animation: spin 1s linear infinite;
}
```
  </action>
  <verify>
```bash
# New props accepted
grep -E "(hasLibrary|isStale|isRefreshing|onRefresh)" renderer/components/AppHeader.jsx

# Refresh button present
grep "refresh-btn" renderer/components/AppHeader.jsx

# Stale indicator present
grep "stale-indicator" renderer/components/AppHeader.jsx

# CSS exists
grep "refresh-btn" renderer/styles/components.css
```
  </verify>
  <done>
AppHeader shows Refresh Library button and stale warning indicator when library is loaded
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire props from App.jsx and add three-stage parse progress</name>
  <files>renderer/App.jsx</files>
  <action>
**A. Pass new props to AppHeader:**
```jsx
<AppHeader
  onSettingsClick={() => console.log('Settings')}
  hasLibrary={tracks.length > 0}
  isStale={libraryCacheInfo?.stale ?? false}
  isRefreshing={isParsing}
  onRefresh={refreshLibrary}
/>
```

**B. Pass new props to SetupWizard:**
```jsx
<SetupWizard
  onFileSelect={handleFileSelect}
  isLoading={isParsing}
  recentImports={recentImports}
  usbAnlzPath={usbAnlzPath}
  anlzDetected={anlzDetected}
  onAnlzPathChange={setUsbAnlzPath}
  onPickAnlzFolder={pickUsbAnlzFolder}
/>
```

**C. Add three-stage parse progress display**

Add state: `const [parseStage, setParseStage] = useState('');`

In the `parse()` function, set stages at key points:
```javascript
setParseStage('Parsing XML...');
// ... parseLibrary call starts ...

// In onAnlzBuildProgress subscription:
bridgeApi.onAnlzBuildProgress?.((p) => {
  setParseStage(`Building waveform index: ${(p.scanned || 0).toLocaleString()} / ${(p.total || 0).toLocaleString()} files...`);
});

// After parseLibrary resolves, before attaching waveforms:
// (This happens server-side, but we can show final message)
setParseStage('');
```

In the parse progress display area (where `isParsing` is shown), add:
```jsx
{isParsing && parseStage && (
  <div className="parse-stage-label">{parseStage}</div>
)}
```

**D. Add CSS:**
```css
.parse-stage-label {
  font-size: var(--text-sm);
  color: var(--text-secondary);
  margin-top: var(--space-2);
  font-family: var(--font-mono);
}
```
  </action>
  <verify>
```bash
# AppHeader receives hasLibrary, isStale, isRefreshing, onRefresh
grep -A 5 "<AppHeader" renderer/App.jsx | grep -E "(hasLibrary|isStale|onRefresh)"

# SetupWizard receives usbAnlzPath, anlzDetected, onPickAnlzFolder
grep -A 8 "<SetupWizard" renderer/App.jsx | grep -E "(usbAnlzPath|anlzDetected|onPickAnlzFolder)"

# Parse stage state added
grep "parseStage" renderer/App.jsx

# Parse stage displayed
grep "parse-stage-label" renderer/App.jsx
```
  </verify>
  <done>
AppHeader and SetupWizard receive all new props; three-stage parse progress shown during library loading
  </done>
</task>

</tasks>

<success_criteria>
**Acceptance:**
1. SetupWizard shows "Waveform Data" section with ANLZ path (or placeholder if not found)
2. "Auto-detected" green badge visible when ANLZ path was found automatically
3. Browse button opens folder picker if user wants to override path
4. App header shows "Refresh Library" button when library is loaded
5. Clicking "Refresh Library" re-parses library (re-runs ANLZ build if needed)
6. Stale yellow indicator appears when XML has changed since last parse
7. During parse: three distinct progress messages visible:
   - "Parsing XML..."
   - "Building waveform index: 3,421 / 12,012 files..."
   - (waveform attachment is fast — no separate stage needed)

**Testing:**
```bash
npm run start:electron:safe

# SetupWizard test (fresh state):
# 1. Open app without cached library → SetupWizard shown
# 2. "Waveform Data" section visible below drop zone
# 3. If Rekordbox installed: ANLZ path pre-filled with "Auto-detected" badge
# 4. If not detected: placeholder text shown, Browse button available
# 5. Click Browse → folder picker opens → select USBANLZ folder

# Parse progress test:
# 1. Parse library with ANLZ path set
# 2. Watch parse progress area
# 3. Should see "Parsing XML..." first
# 4. Then "Building waveform index: X / Y files..." cycling up
# 5. Progress disappears when done

# Header test (after library loaded):
# 1. "Refresh Library" button visible in header
# 2. Click it → parse progress starts → library reloads
# 3. Touch XML file (modify mtime) → reopen app → yellow stale badge visible
# 4. Click "Refresh Library" → stale indicator disappears after re-parse
```
</success_criteria>

<must_have_derivation>
**Goal:** Discoverable, satisfying UX for ANLZ setup and library refresh

**Critical behaviors:**
- ANLZ section must be visible on the very first screen users see (SetupWizard)
- Auto-detect badge confirms the system found Rekordbox automatically
- Refresh Library in header is always accessible without navigating away
- Stale indicator prevents users from working with outdated library silently

**Critical artifacts:**
- SetupWizard with ANLZ section
- AppHeader with refresh + stale indicator
- Three-stage parse progress display

**Critical connections:**
- All state (`usbAnlzPath`, `anlzDetected`, `libraryCacheInfo`) lives in App.jsx
- `refreshLibrary()` from Plan 01 wired to AppHeader's `onRefresh`
- `pickUsbAnlzFolder()` from App.jsx wired to SetupWizard's `onPickAnlzFolder`
- CSS additions go into `renderer/styles/components.css`
</must_have_derivation>
